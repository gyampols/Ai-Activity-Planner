version: 2.1

# Define orbs for easier integration
orbs:
  gcp-cli: circleci/gcp-cli@3.1.0

# Define jobs
jobs:
  test:
    docker:
      - image: cimg/python:3.11
    steps:
      - checkout
      
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "requirements.txt" }}
            - v1-dependencies-
      
      - run:
          name: Install dependencies
          command: |
            python -m venv venv
            . venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt
      
      - save_cache:
          paths:
            - ./venv
          key: v1-dependencies-{{ checksum "requirements.txt" }}
      
      - run:
          name: Run basic validation
          command: |
            . venv/bin/activate
            # Check if app.py has syntax errors
            python -m py_compile app.py
            python -m py_compile models.py
            python -m py_compile config.py
            # Check routes
            python -m py_compile routes/auth.py
            python -m py_compile routes/activities.py
            python -m py_compile routes/planning.py
            python -m py_compile routes/integrations.py
            python -m py_compile routes/main.py
            # Check utils
            python -m py_compile utils/helpers.py
            echo "All Python files compiled successfully!"

  deploy:
    docker:
      - image: cimg/python:3.11
    steps:
      - checkout
      
      - gcp-cli/setup:
          version: "latest"
      
      - run:
          name: Authenticate with Google Cloud
          command: |
            # Check if GCLOUD_SERVICE_KEY is set
            if [ -z "$GCLOUD_SERVICE_KEY" ]; then
              echo "ERROR: GCLOUD_SERVICE_KEY environment variable is not set!"
              exit 1
            fi
            
            # Debug: Show length of the key (not the actual key)
            echo "GCLOUD_SERVICE_KEY length: ${#GCLOUD_SERVICE_KEY}"
            
            # Decode the service account key from environment variable
            # Use printf instead of echo to avoid any shell interpretation
            printf '%s' "$GCLOUD_SERVICE_KEY" | base64 -d > ${HOME}/gcloud-service-key.json
            
            # Check if file was created and has content
            if [ ! -s ${HOME}/gcloud-service-key.json ]; then
              echo "ERROR: Decoded service account key is empty!"
              echo "First 100 chars of base64 string: ${GCLOUD_SERVICE_KEY:0:100}"
              exit 1
            fi
            
            # Verify the JSON is valid
            if ! python3 -m json.tool ${HOME}/gcloud-service-key.json > /dev/null 2>&1; then
              echo "ERROR: Decoded service account key is not valid JSON!"
              echo "File size: $(wc -c < ${HOME}/gcloud-service-key.json) bytes"
              echo "First 200 chars of decoded content:"
              head -c 200 ${HOME}/gcloud-service-key.json
              exit 1
            fi
            
            echo "âœ“ Service account key decoded and validated successfully"
            
            # Authenticate
            gcloud auth activate-service-account --key-file=${HOME}/gcloud-service-key.json
            gcloud config set project $GOOGLE_PROJECT_ID
      
      - run:
          name: Deploy to Cloud Run
          command: |
            gcloud run deploy ai-activity-planner \
              --source . \
              --platform managed \
              --region us-central1 \
              --allow-unauthenticated \
              --min-instances=0 \
              --max-instances=10 \
              --memory=512Mi \
              --set-env-vars="SECRET_KEY=$SECRET_KEY,OPENAI_API_KEY=$OPENAI_API_KEY,GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID,GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET,FITBIT_CLIENT_ID=$FITBIT_CLIENT_ID,FITBIT_CLIENT_SECRET=$FITBIT_CLIENT_SECRET,BASE_URL=$BASE_URL"
      
      - run:
          name: Deployment successful
          command: |
            echo "Deployment completed successfully!"
            echo "Application URL: https://ai-activity-planner-mola55j5ra-uc.a.run.app"

# Define workflows
workflows:
  version: 2
  test-and-deploy:
    jobs:
      - test:
          filters:
            branches:
              ignore:
                - /^dependabot.*/
      
      - deploy:
          requires:
            - test
          filters:
            branches:
              only:
                - main
          context:
            - gcp-deployment
