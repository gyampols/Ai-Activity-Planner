{% extends "base.html" %}

{% block title %}Generate Plan - AI Activity Planner{% endblock %}

{% block extra_css %}
<style>
    /* Toggle switch styles */
    .toggle-switch {
        position: relative;
        width: 44px;
        height: 24px;
        flex-shrink: 0;
    }
    
    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    
    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.3s;
        border-radius: 24px;
    }
    
    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.3s;
        border-radius: 50%;
    }
    
    input:checked + .toggle-slider {
        background-color: #27ae60;
    }
    
    input:checked + .toggle-slider:before {
        transform: translateX(20px);
    }
    
    .activity-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        background: #f8f9fa;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        border-radius: 4px;
    }
    
    .activity-item.disabled {
        opacity: 0.5;
        background: #e9ecef;
    }
    
    .activity-info {
        flex: 1;
    }

    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 0.5rem;
        margin-top: 1rem;
    }
    
    .calendar-day {
        background: white;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 1rem;
        min-height: 150px;
        transition: all 0.3s;
    }
    
    .calendar-day:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    
    .calendar-day-header {
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 0.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #3498db;
    }
    
    .calendar-activity {
        background: #e3f2fd;
        padding: 0.5rem;
        border-radius: 4px;
        margin: 0.5rem 0;
        font-weight: 600;
        color: #1976d2;
    }
    
    .calendar-notes {
        font-size: 0.9rem;
        color: #666;
        margin-top: 0.5rem;
    }
    
    .calendar-weather {
        font-size: 0.85rem;
        color: #888;
        margin-top: 0.3rem;
        padding-top: 0.3rem;
        border-top: 1px solid #eee;
    }
    
    .rest-day {
        background: #f8f9fa;
        border-color: #ced4da;
    }
    
    .rest-day .calendar-activity {
        background: #e9ecef;
        color: #6c757d;
    }
    
    .weather-section {
        background: #f0f8ff;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
    }
    
    .weather-container {
        display: flex;
        flex-wrap: nowrap;
        gap: 0.5rem;
        justify-content: space-between;
        overflow-x: auto;
    }
    
    .weather-day {
        flex: 1 1 0;
        padding: 0.5rem;
        background: white;
        border-radius: 8px;
        text-align: center;
        min-width: 85px;
        max-width: 120px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        font-size: 0.85rem;
    }
    
    .weather-day strong {
        font-size: 0.9rem;
    }
    
    .weather-day small {
        font-size: 0.75rem;
    }
    
    #loading {
        display: none;
        text-align: center;
        padding: 2rem;
    }
    
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* Desktop - 7 columns */
    @media (min-width: 1200px) {
        .calendar-grid {
            grid-template-columns: repeat(7, 1fr);
        }
    }
    
    /* Tablet landscape - 4 columns */
    @media (min-width: 768px) and (max-width: 1199px) {
        .calendar-grid {
            grid-template-columns: repeat(4, 1fr);
        }
    }
    
    /* Tablet portrait - 3 columns */
    @media (min-width: 600px) and (max-width: 767px) {
        .calendar-grid {
            grid-template-columns: repeat(3, 1fr);
        }
        .weather-day {
            min-width: 80px;
            padding: 0.5rem;
        }
    }
    
    /* Mobile - 2 columns */
    @media (min-width: 400px) and (max-width: 599px) {
        .calendar-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        .calendar-day {
            padding: 0.75rem;
            min-height: 130px;
        }
        .weather-day {
            min-width: 70px;
            padding: 0.5rem;
            font-size: 0.9rem;
        }
    }
    
    /* Small mobile - 1 column */
    @media (max-width: 399px) {
        .calendar-grid {
            grid-template-columns: 1fr;
        }
        .calendar-day {
            padding: 0.75rem;
            min-height: auto;
        }
        .weather-day {
            min-width: 70px;
            padding: 0.4rem;
            font-size: 0.85rem;
        }
        h1 {
            font-size: 1.5rem;
        }
        h2 {
            font-size: 1.2rem;
        }
    }
    
    /* Better mobile touch targets and spacing */
    @media (max-width: 767px) {
        .btn {
            padding: 0.75rem 1rem;
            font-size: 1rem;
            width: 100%;
            margin: 0.5rem 0;
        }
        input[type="text"],
        textarea {
            font-size: 16px !important; /* Prevents zoom on iOS */
        }
        .card {
            padding: 1rem;
        }
    }
    
    .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 4px 4px;
        max-height: 250px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        display: none;
    }
    
    .autocomplete-item {
        padding: 0.75rem 1rem;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .autocomplete-item:hover {
        background-color: #f0f8ff;
    }
    
    .autocomplete-item:last-child {
        border-bottom: none;
    }
</style>
{% endblock %}

{% block content %}
<h1>Generate Weekly Plan</h1>

<div class="card">
    <h2>Location & Weather</h2>
    <form method="POST" style="margin-bottom: 1rem;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <div class="form-group" style="position: relative;">
            <label for="location">Your Location (City)</label>
            <input type="text" id="location" name="location" value="{{ current_user.location or '' }}" 
                   placeholder="e.g., San Francisco, London, Tokyo" required autocomplete="off">
            <div id="location-dropdown" class="autocomplete-dropdown"></div>
        </div>
        <button type="submit" class="btn btn-primary">Update Location</button>
    </form>
    
    {% if weather_forecast %}
    <div class="weather-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; flex-wrap: wrap; gap: 0.5rem;">
            <div>
                <h3 style="margin: 0; display: inline;">7-Day Weather Forecast</h3>
                <span id="current-time" style="margin-left: 1rem; color: #666; font-size: 0.95rem;">üïê --:--</span>
            </div>
            <button id="toggle-temp" class="btn" style="background: #34495e; color: white; padding: 0.4rem 0.8rem; font-size: 0.85rem;">
                Switch to ¬∞{{ 'C' if current_user.temperature_unit == 'F' else 'F' }}
            </button>
        </div>
        <div class="weather-container">
            {% for day in weather_forecast %}
                <div class="weather-day" {% if day.is_today %}style="border: 2px solid #3498db;"{% endif %}>
                    <strong>{{ day.date_short }}</strong>{% if day.is_today %} <span style="color: #3498db; font-size: 0.75rem;">(Today)</span>{% endif %}<br>
                    üå°Ô∏è <span class="temp-display">{{ day.temp_max }}¬∞/{{ day.temp_min }}¬∞</span><br>
                    {# Dynamic precipitation emoji based on weathercode #}
                    {% set wc = day.weathercode|default(0)|int %}
                    {% if wc in [95] %}‚õàÔ∏è{% elif wc in [96, 99] %}‚õàÔ∏èüßä{% elif wc in [71, 73, 75, 77, 85, 86] %}‚ùÑÔ∏è{% elif wc in [56, 57, 66, 67] %}üåßÔ∏è‚ùÑÔ∏è{% elif wc in [51, 53, 55, 61, 63, 65, 80, 81, 82] %}üåßÔ∏è{% else %}üíß{% endif %}{{ day.precipitation }}%<br>
                    ‚òÅÔ∏è{{ day.cloud_cover or 0 }}%<br>
                    üí®{{ day.wind_speed or 0 }}mph<br>
                    <small style="color: #666;">üåÖ{{ day.sunrise }}<br> üåá{{ day.sunset }}</small>
                    {% if day.is_wet_ground or day.is_snowy_ground or day.is_windy %}
                    <div style="font-size: 0.7rem; margin-top: 0.25rem;">
                        {% if day.is_windy %}üí®Windy{% endif %}
                        {% if day.is_wet_ground %}‚ö†Ô∏èWet{% endif %}
                        {% if day.is_snowy_ground %}‚ùÑÔ∏èSnow{% endif %}
                    </div>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    </div>
    <script>
        function updateCurrentTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
            document.getElementById('current-time').textContent = 'üïê ' + timeStr;
        }
        updateCurrentTime();
        setInterval(updateCurrentTime, 60000);
    </script>
    {% endif %}
</div>

<div class="card">
    <h2>Your Activities</h2>
    {% if activities %}
        <p style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">Toggle activities to include/exclude from your plan:</p>
        <div style="margin-top: 0.5rem;" id="activities-list">
            {% for activity in activities %}
                <div class="activity-item" data-activity-id="{{ activity.id }}">
                    <label class="toggle-switch">
                        <input type="checkbox" class="activity-toggle" data-activity-id="{{ activity.id }}" checked>
                        <span class="toggle-slider"></span>
                    </label>
                    <div class="activity-info">
                        <strong>{{ activity.name }}</strong>
                        {% if activity.duration_minutes %}
                            - {{ activity.duration_minutes }} min
                        {% endif %}
                        {% if activity.intensity %}
                            ({{ activity.intensity }})
                        {% endif %}
                        {% if activity.dependencies %}
                            - {{ activity.dependencies }}
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
        
        {% if current_user.fitbit_connected %}
            <div style="margin-top: 1rem; padding: 1rem; background: #d4edda; border-radius: 4px;">
                {% if current_user.fitbit_readiness_score %}
                    <strong>Fitbit Readiness:</strong> {{ current_user.fitbit_readiness_score }}/100
                {% endif %}
                {% if current_user.fitbit_sleep_score %}
                    {% if current_user.fitbit_readiness_score %}<br>{% endif %}
                    <strong>Sleep Score:</strong> {{ current_user.fitbit_sleep_score }}%
                {% endif %}
                {% if not current_user.fitbit_readiness_score %}
                    <div style="margin-top:0.5rem; color:#155724;">
                        Readiness not available yet. This can happen if Premium isn‚Äôt active or the day‚Äôs score hasn‚Äôt been finalized after device sync.
                        <button id="refresh-fitbit" class="btn btn-sm" style="background:#218838; color:white; margin-left:0.5rem;">Refresh Fitbit Data</button>
                    </div>
                {% endif %}
            </div>
        {% elif current_user.oura_connected and current_user.oura_readiness_score %}
            <div style="margin-top: 1rem; padding: 1rem; background: #d4edda; border-radius: 4px;">
                <strong>Oura Readiness:</strong> {{ current_user.oura_readiness_score }}/100
            </div>
        {% else %}
            <!-- Manual Fitness Score Input (shown when no tracker connected) -->
            <div style="margin-top: 1rem; padding: 1rem; background: #fff3cd; border-radius: 4px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                    <strong style="color: #856404;">Today's Energy Levels (Optional)</strong>
                    <button id="toggle-manual-scores" type="button" class="btn" style="background: #856404; color: white; padding: 0.4rem 0.8rem; font-size: 0.85rem;">
                        {% if current_user.manual_readiness_score %}Update{% else %}Add{% endif %}
                    </button>
                </div>
                
                <div id="manual-scores-form" style="display: none;">
                    <div style="margin-bottom: 0.75rem;">
                        <label for="manual-readiness" style="display: block; margin-bottom: 0.25rem; font-size: 0.9rem;">
                            Readiness (0-100): How ready do you feel for physical activity?
                        </label>
                        <input type="range" id="manual-readiness" min="0" max="100" value="{{ current_user.manual_readiness_score or 70 }}" style="width: 100%;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.85rem; color: #666;">
                            <span>Low (0)</span>
                            <span id="readiness-value" style="font-weight: 600; color: #856404;">{{ current_user.manual_readiness_score or 70 }}</span>
                            <span>High (100)</span>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 0.75rem;">
                        <label for="manual-sleep" style="display: block; margin-bottom: 0.25rem; font-size: 0.9rem;">
                            Sleep Quality (0-100): How well did you sleep last night?
                        </label>
                        <input type="range" id="manual-sleep" min="0" max="100" value="{{ current_user.manual_sleep_score or 70 }}" style="width: 100%;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.85rem; color: #666;">
                            <span>Poor (0)</span>
                            <span id="sleep-value" style="font-weight: 600; color: #856404;">{{ current_user.manual_sleep_score or 70 }}</span>
                            <span>Excellent (100)</span>
                        </div>
                    </div>
                    
                    <button type="button" id="save-manual-scores" class="btn btn-success" style="width: 100%; padding: 0.6rem;">
                        Save Scores
                    </button>
                </div>
                
                {% if current_user.manual_readiness_score and current_user.manual_score_date %}
                    <div style="font-size: 0.85rem; color: #856404; margin-top: 0.5rem;">
                        Last updated: {{ current_user.manual_score_date.strftime('%b %d, %Y') }} - 
                        Readiness: {{ current_user.manual_readiness_score }}/100
                        {% if current_user.manual_sleep_score %}, Sleep: {{ current_user.manual_sleep_score }}/100{% endif %}
                    </div>
                {% endif %}
            </div>
        {% endif %}
        
        <div style="margin-top: 1.5rem;">
            <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 1rem;">
                <input type="checkbox" id="allow-multiple-activities" style="width: auto; margin-right: 0.5rem;">
                <span style="font-weight: 600;">Allow multiple activities per day</span>
            </label>
            
            <label for="last-activity" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                Last Activity Completed (Optional)
            </label>
            <input 
                type="text" 
                id="last-activity" 
                value="{{ last_completed_activity }}"
                placeholder="e.g., 5k run, yoga session, strength training"
                style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; margin-bottom: 1rem;"
            >
            
            <label for="injuries-pains" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                ü©π Current Injuries or Pains (Optional)
            </label>
            <input 
                type="text" 
                id="injuries-pains" 
                value="{{ current_injuries }}"
                placeholder="e.g., sore knee, lower back pain, recovering from ankle sprain"
                style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; margin-bottom: 1rem;"
            >
            
            <label for="extra-info" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                Additional Information (Optional)
            </label>
            <textarea 
                id="extra-info" 
                placeholder="Add any extra context for your plan (e.g., training for event, specific goals, time constraints, etc.)"
                style="width: 100%; min-height: 80px; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; resize: vertical;"
            >{{ additional_information }}</textarea>
        </div>
        
        <button id="generate-btn" class="btn btn-success" style="margin-top: 1rem;">
            ü§ñ Generate AI-Powered Weekly Plan
        </button>
        
        <div id="loading">
            <div class="spinner"></div>
            <p style="margin-top: 1rem;">Generating your personalized plan with weather data...</p>
        </div>
        
        <div id="calendar-container" style="display: none; margin-top: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2 style="margin: 0;">Your Weekly Activity Calendar</h2>
                {% if (current_user.subscription_tier == 'paid_tier' or current_user.subscription_tier == 'admin') %}
                    {% if current_user.google_id %}
                    <button id="export-calendar-btn" class="btn btn-success" style="display: none;">
                        üìÖ Export to Google Calendar
                    </button>
                    {% else %}
                    <p style="margin: 0; color: #666; font-size: 0.9rem;">
                        <a href="{{ url_for('integrations.connect_google') }}" style="color: #3498db;">Connect Google Account</a> to export to calendar
                    </p>
                    {% endif %}
                {% else %}
                <p style="margin: 0; color: #666; font-size: 0.9rem;">
                    üìÖ Calendar export available with <a href="{{ url_for('main.settings') }}#subscription" style="color: #3498db;">Paid Plan</a>
                </p>
                {% endif %}
            </div>
            <div class="calendar-grid" id="calendar-grid"></div>
        </div>
    {% else %}
        <p style="margin-top: 1rem; color: #666;">
            You haven't added any activities yet. 
            <a href="{{ url_for('activities.log') }}" style="color: #3498db;">Add some activities</a> 
            to generate a plan.
        </p>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Cookie utility functions
    function setCookie(name, value, days = 30) {
        const date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        const expires = "expires=" + date.toUTCString();
        document.cookie = name + "=" + encodeURIComponent(value) + ";" + expires + ";path=/";
    }
    
    function getCookie(name) {
        const nameEQ = name + "=";
        const ca = document.cookie.split(';');
        for(let i = 0; i < ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0) == ' ') c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) == 0) return decodeURIComponent(c.substring(nameEQ.length, c.length));
        }
        return null;
    }
    
    // Function to display persisted schedule on page load
    function displayPersistedSchedule(plan, scheduleDate) {
        const calendarContainer = document.getElementById('calendar-container');
        const calendarGrid = document.getElementById('calendar-grid');
        
        if (!calendarContainer || !calendarGrid) return;
        
        // Check if this is a text-based schedule
        if (plan.text) {
            const fallbackDiv = document.createElement('div');
            fallbackDiv.style.cssText = 'grid-column: 1/-1; padding: 1rem; background: #f8f9fa; border-radius: 4px; white-space: pre-wrap;';
            fallbackDiv.textContent = plan.text;
            calendarGrid.innerHTML = '';
            calendarGrid.appendChild(fallbackDiv);
        } else {
            // Display as calendar
            calendarGrid.innerHTML = '';
            
            // Sort by date keys to ensure proper order
            const dateKeys = Object.keys(plan).sort();
            
            dateKeys.forEach(dateKey => {
                const dayData = plan[dateKey];
                const dayCard = document.createElement('div');
                const isRest = (dayData.activity || '').toLowerCase().includes('rest');
                dayCard.className = 'calendar-day' + (isRest ? ' rest-day' : '');
                
                // Create elements safely to prevent XSS
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = dayData.day_name || dateKey;
                dayCard.appendChild(header);
                
                const activity = document.createElement('div');
                activity.className = 'calendar-activity';
                activity.textContent = dayData.activity || 'No activity';
                dayCard.appendChild(activity);
                
                if (dayData.notes) {
                    const notes = document.createElement('div');
                    notes.className = 'calendar-notes';
                    notes.textContent = dayData.notes;
                    dayCard.appendChild(notes);
                }
                
                if (dayData.weather) {
                    const weather = document.createElement('div');
                    weather.className = 'calendar-weather';
                    weather.textContent = '‚òÅÔ∏è ' + dayData.weather;
                    dayCard.appendChild(weather);
                }
                
                calendarGrid.appendChild(dayCard);
            });
            
            // Store plan data globally for export
            window.currentPlan = plan;
        }
        
        // Add a header showing when this schedule was generated
        const headerDiv = calendarContainer.querySelector('div');
        if (headerDiv && scheduleDate) {
            const dateStr = new Date(scheduleDate).toLocaleDateString(undefined, { 
                weekday: 'short', 
                month: 'short', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            const existingBadge = headerDiv.querySelector('.persisted-badge');
            if (existingBadge) existingBadge.remove();
            
            const badge = document.createElement('span');
            badge.className = 'persisted-badge';
            badge.style.cssText = 'font-size: 0.8rem; color: #666; margin-left: 0.5rem; font-weight: normal;';
            badge.textContent = '(Generated ' + dateStr + ')';
            headerDiv.querySelector('h2').appendChild(badge);
        }
        
        // Show export button if Google is connected
        const exportBtn = document.getElementById('export-calendar-btn');
        if (exportBtn && !plan.text) {
            exportBtn.style.display = '{% if current_user.google_id %}inline-block{% else %}none{% endif %}';
        }
        
        calendarContainer.style.display = 'block';
    }
    
    // Activity toggles and page load handling
    window.addEventListener('DOMContentLoaded', function() {
        // Load saved activity toggle states from cookies
        const savedActivityToggles = getCookie('activityToggles');
        let toggleStates = {};
        if (savedActivityToggles) {
            try {
                toggleStates = JSON.parse(savedActivityToggles);
            } catch (e) {
                toggleStates = {};
            }
        }
        
        // Activity toggle handlers
        document.querySelectorAll('.activity-toggle').forEach(toggle => {
            const activityId = toggle.dataset.activityId;
            
            // Restore saved state if available
            if (toggleStates.hasOwnProperty(activityId)) {
                toggle.checked = toggleStates[activityId];
                const activityItem = toggle.closest('.activity-item');
                if (!toggle.checked) {
                    activityItem.classList.add('disabled');
                }
            }
            
            toggle.addEventListener('change', function() {
                const activityItem = this.closest('.activity-item');
                if (this.checked) {
                    activityItem.classList.remove('disabled');
                } else {
                    activityItem.classList.add('disabled');
                }
                
                // Save all toggle states to cookies
                const currentStates = {};
                document.querySelectorAll('.activity-toggle').forEach(t => {
                    currentStates[t.dataset.activityId] = t.checked;
                });
                setCookie('activityToggles', JSON.stringify(currentStates), 30);
            });
        });
        
        // Load and display persisted schedule if available
        {% if last_schedule %}
        const lastSchedule = {{ last_schedule | tojson | safe }};
        const lastScheduleDate = '{{ last_schedule_date }}';
        if (lastSchedule && Object.keys(lastSchedule).length > 0) {
            displayPersistedSchedule(lastSchedule, lastScheduleDate);
        }
        {% endif %}
    });
    
    // Manual fitness score handlers
    const toggleBtn = document.getElementById('toggle-manual-scores');
    const manualForm = document.getElementById('manual-scores-form');
    const readinessSlider = document.getElementById('manual-readiness');
    const sleepSlider = document.getElementById('manual-sleep');
    const readinessValue = document.getElementById('readiness-value');
    const sleepValue = document.getElementById('sleep-value');
    const saveBtn = document.getElementById('save-manual-scores');
    
    if (toggleBtn && manualForm) {
        toggleBtn.addEventListener('click', function() {
            manualForm.style.display = manualForm.style.display === 'none' ? 'block' : 'none';
        });
    }
    
    if (readinessSlider && readinessValue) {
        readinessSlider.addEventListener('input', function() {
            readinessValue.textContent = this.value;
        });
    }
    
    if (sleepSlider && sleepValue) {
        sleepSlider.addEventListener('input', function() {
            sleepValue.textContent = this.value;
        });
    }
    
    if (saveBtn) {
        saveBtn.addEventListener('click', async function() {
            const readiness = readinessSlider?.value;
            const sleep = sleepSlider?.value;
            
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';
            
            try {
                const response = await fetch('{{ url_for("planning.update_manual_scores") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        readiness_score: parseInt(readiness),
                        sleep_score: parseInt(sleep)
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('‚úÖ Scores saved successfully!');
                    location.reload();
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Failed to save scores'));
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Scores';
            }
        });
    }
    
    // Plan generation handler
    document.getElementById('generate-btn')?.addEventListener('click', async function() {
        const btn = this;
        const loading = document.getElementById('loading');
        const calendarContainer = document.getElementById('calendar-container');
        const calendarGrid = document.getElementById('calendar-grid');
        const extraInfo = document.getElementById('extra-info')?.value || '';
        const lastActivity = document.getElementById('last-activity')?.value || '';
        const injuriesPains = document.getElementById('injuries-pains')?.value || '';
        const allowMultiple = document.getElementById('allow-multiple-activities')?.checked || false;
        
        // Get excluded activity IDs (unchecked toggles)
        const excludedActivityIds = [];
        document.querySelectorAll('.activity-toggle').forEach(toggle => {
            if (!toggle.checked) {
                excludedActivityIds.push(parseInt(toggle.dataset.activityId));
            }
        });
        
        // Values are now saved to database automatically when plan is generated
        
        btn.disabled = true;
        btn.textContent = 'Generating...';
        loading.style.display = 'block';
        calendarContainer.style.display = 'none';
        
        try {
            const response = await fetch('{{ url_for("planning.generate_plan") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    extra_info: extraInfo,
                    last_activity: lastActivity,
                    injuries_pains: injuriesPains,
                    allow_multiple_activities: allowMultiple,
                    excluded_activity_ids: excludedActivityIds
                })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                console.log('Received data:', data); // Debug log
                if (data.structured && typeof data.plan === 'object') {
                    // Display as calendar
                    calendarGrid.innerHTML = '';
                    const plan = data.plan;
                    
                    // Sort by date keys to ensure proper order
                    const dateKeys = Object.keys(plan).sort();
                    
                    dateKeys.forEach(dateKey => {
                        const dayData = plan[dateKey];
                        const dayCard = document.createElement('div');
                        const isRest = (dayData.activity || '').toLowerCase().includes('rest');
                        dayCard.className = 'calendar-day' + (isRest ? ' rest-day' : '');
                        
                        // Create elements safely to prevent XSS
                        const header = document.createElement('div');
                        header.className = 'calendar-day-header';
                        header.textContent = dayData.day_name || dateKey;
                        dayCard.appendChild(header);
                        
                        const activity = document.createElement('div');
                        activity.className = 'calendar-activity';
                        activity.textContent = dayData.activity || 'No activity';
                        dayCard.appendChild(activity);
                        
                        if (dayData.notes) {
                            const notes = document.createElement('div');
                            notes.className = 'calendar-notes';
                            notes.textContent = dayData.notes;
                            dayCard.appendChild(notes);
                        }
                        
                        if (dayData.weather) {
                            const weather = document.createElement('div');
                            weather.className = 'calendar-weather';
                            weather.textContent = '‚òÅÔ∏è ' + dayData.weather;
                            dayCard.appendChild(weather);
                        }
                        
                        calendarGrid.appendChild(dayCard);
                    });
                    
                    // Store plan data globally for export
                    window.currentPlan = plan;
                    
                    // Show export button if Google is connected
                    const exportBtn = document.getElementById('export-calendar-btn');
                    if (exportBtn) {
                        exportBtn.style.display = '{% if current_user.google_id %}inline-block{% else %}none{% endif %}';
                    }
                    
                    calendarContainer.style.display = 'block';
                } else {
                    // Display as text (fallback) - use textContent to prevent XSS
                    const fallbackDiv = document.createElement('div');
                    fallbackDiv.style.cssText = 'grid-column: 1/-1; padding: 1rem; background: #f8f9fa; border-radius: 4px; white-space: pre-wrap;';
                    fallbackDiv.textContent = data.plan;
                    calendarGrid.innerHTML = '';
                    calendarGrid.appendChild(fallbackDiv);
                    calendarContainer.style.display = 'block';
                }
            } else {
                // Display error - use textContent to prevent XSS
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = 'grid-column: 1/-1; padding: 1rem; background: #f8d7da; border-radius: 4px; color: #721c24;';
                errorDiv.textContent = 'Error: ' + (data.error || 'Failed to generate plan');
                calendarGrid.innerHTML = '';
                calendarGrid.appendChild(errorDiv);
                calendarContainer.style.display = 'block';
            }
        } catch (error) {
            // Display error - use textContent to prevent XSS
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = 'grid-column: 1/-1; padding: 1rem; background: #f8d7da; border-radius: 4px; color: #721c24;';
            errorDiv.textContent = 'Error: ' + error.message;
            calendarGrid.innerHTML = '';
            calendarGrid.appendChild(errorDiv);
            calendarContainer.style.display = 'block';
        } finally {
            btn.disabled = false;
            btn.textContent = 'ü§ñ Generate AI-Powered Weekly Plan';
            loading.style.display = 'none';
        }
    });

    // Location autocomplete
    const locationInput = document.getElementById('location');
    const dropdown = document.getElementById('location-dropdown');
    let searchTimeout;

    locationInput.addEventListener('input', function() {
        const query = this.value.trim();
        
        clearTimeout(searchTimeout);
        
        if (query.length < 2) {
            dropdown.style.display = 'none';
            return;
        }
        
        searchTimeout = setTimeout(async () => {
            try {
                const response = await fetch(`/search_cities?q=${encodeURIComponent(query)}`);
                const cities = await response.json();
                
                if (cities.length > 0) {
                    dropdown.innerHTML = cities.map(city => 
                        `<div class="autocomplete-item" data-city="${city.name}">${city.display}</div>`
                    ).join('');
                    dropdown.style.display = 'block';
                } else {
                    dropdown.style.display = 'none';
                }
            } catch (error) {
                console.error('City search error:', error);
                dropdown.style.display = 'none';
            }
        }, 300);
    });

    dropdown.addEventListener('click', function(e) {
        if (e.target.classList.contains('autocomplete-item')) {
            locationInput.value = e.target.dataset.city;
            dropdown.style.display = 'none';
        }
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (e.target !== locationInput && e.target !== dropdown) {
            dropdown.style.display = 'none';
        }
    });

    // Temperature unit toggle
    const toggleTempBtn = document.getElementById('toggle-temp');
    if (toggleTempBtn) {
        toggleTempBtn.addEventListener('click', async function() {
            try {
                const csrfToken = document.querySelector('input[name="csrf_token"]')?.value;
                const response = await fetch('/toggle_temperature_unit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    }
                });
                const data = await response.json();
                if (response.ok) {
                    // Reload page to show new temperatures
                    window.location.reload();
                } else {
                    console.error('Temperature toggle failed:', data);
                }
            } catch (error) {
                console.error('Temperature toggle error:', error);
            }
        });
    }

    // Export to Google Calendar
    const exportBtn = document.getElementById('export-calendar-btn');
    if (exportBtn) {
        exportBtn.addEventListener('click', async function() {
            if (!window.currentPlan) {
                alert('No plan to export. Please generate a plan first.');
                return;
            }
            
            const btn = this;
            btn.disabled = true;
            btn.textContent = 'Checking for conflicts...';
            
            try {
                // First, check for conflicts
                const checkResponse = await fetch('{{ url_for("planning.check_calendar_conflicts") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        plan: window.currentPlan
                    })
                });
                
                const checkData = await checkResponse.json();
                
                // If there are conflicts, ask user what to do
                if (checkResponse.ok && checkData.hasConflicts) {
                    const userChoice = confirm(
                        `‚ö†Ô∏è ${checkData.message}\n\n` +
                        `Do you want to update those events with your new plan?\n\n` +
                        `‚Ä¢ Click OK to update existing events\n` +
                        `‚Ä¢ Click Cancel to abort export`
                    );
                    
                    if (!userChoice) {
                        btn.disabled = false;
                        btn.textContent = 'üìÖ Export to Google Calendar';
                        return; // User chose to cancel
                    }
                }
                
                // Proceed with export
                btn.textContent = 'Exporting...';
                
                const response = await fetch('{{ url_for("planning.export_to_google_calendar") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        plan: window.currentPlan
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    let message = '‚úÖ ' + data.message + '\n\nCheck your Google Calendar to see the events.';
                    if (data.updated > 0) {
                        message += `\n\nüìù Note: ${data.updated} existing event(s) were updated.`;
                    }
                    alert(message);
                } else if (response.status === 403) {
                    alert('‚ö†Ô∏è ' + (data.error || 'Calendar access denied') + '\n\nTip: You may need to disconnect and reconnect your Google account to grant calendar permissions.');
                } else {
                    alert('‚ùå Export failed: ' + (data.error || data.message || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Export error: ' + error.message + '\n\nPlease try again or reconnect your Google account.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üìÖ Export to Google Calendar';
            }
        });
    }

    // Refresh Fitbit data
    const refreshFitbitBtn = document.getElementById('refresh-fitbit');
    if (refreshFitbitBtn) {
        refreshFitbitBtn.addEventListener('click', async function(e) {
            e.preventDefault();
            try {
                const resp = await fetch('/refresh_fitbit', { method: 'POST' });
                if (resp.redirected) {
                    window.location.href = resp.url;
                } else {
                    window.location.reload();
                }
            } catch (err) {
                console.error('Refresh Fitbit failed', err);
            }
        });
    }
</script>
{% endblock %}
